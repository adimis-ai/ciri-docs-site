"use strict";(self.webpackChunkciri_docs=self.webpackChunkciri_docs||[]).push([[4274],{5943(e,s,r){r.r(s),r.d(s,{assets:()=>a,contentTitle:()=>t,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"internals/middlewares","title":"Middleware Stack","description":"Ciri\'s intelligence is not monolithic \u2014 it is assembled from a layered middleware stack that transforms every agent turn. Each middleware wraps the LLM call to inject context, enforce safety, manage state, or add capabilities.","source":"@site/docs/internals/middlewares.md","sourceDirName":"internals","slug":"/internals/middlewares","permalink":"/docs/internals/middlewares","draft":false,"unlisted":false,"editUrl":"https://github.com/adimis-ai/ciri/tree/main/docs-site/docs/internals/middlewares.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Copilot Controller","permalink":"/docs/internals/controller"},"next":{"title":"Self-Evolution & Training","permalink":"/docs/internals/self-evolution"}}');var n=r(4848),l=r(8453);const d={},t="Middleware Stack",a={},o=[{value:"Overview",id:"overview",level:2},{value:"Middleware Reference",id:"middleware-reference",level:2},{value:"1. <code>MemoryMiddleware</code>",id:"1-memorymiddleware",level:3},{value:"2. <code>SkillsMiddleware</code>",id:"2-skillsmiddleware",level:3},{value:"3. <code>SubAgentMiddleware</code>",id:"3-subagentmiddleware",level:3},{value:"4. <code>ToolkitInjectionMiddleware</code>",id:"4-toolkitinjectionmiddleware",level:3},{value:"5. <code>HumanInTheLoopMiddleware</code>",id:"5-humanintheloopmiddleware",level:3},{value:"6. <code>TodoListMiddleware</code>",id:"6-todolistmiddleware",level:3},{value:"7. <code>InjectAvailableToolNamesMiddleware</code>",id:"7-injectavailabletoolnamesmiddleware",level:3},{value:"8. <code>InjectAvailableSubAgentNamesMiddleware</code>",id:"8-injectavailablesubagentnamesmiddleware",level:3},{value:"9. <code>InjectAvailableSkillNamesMiddleware</code>",id:"9-injectavailableskillnamesmiddleware",level:3},{value:"10. <code>ToolRetryMiddleware</code>",id:"10-toolretrymiddleware",level:3},{value:"11. <code>PatchToolCallsMiddleware</code>",id:"11-patchtoolcallsmiddleware",level:3},{value:"12. <code>FilesystemMiddleware</code>",id:"12-filesystemmiddleware",level:3},{value:"13. <code>SummarizationMiddleware</code>",id:"13-summarizationmiddleware",level:3},{value:"14. <code>AnthropicPromptCachingMiddleware</code>",id:"14-anthropicpromptcachingmiddleware",level:3},{value:"Adding Custom Middleware",id:"adding-custom-middleware",level:2}];function c(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,l.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.header,{children:(0,n.jsx)(s.h1,{id:"middleware-stack",children:"Middleware Stack"})}),"\n",(0,n.jsx)(s.p,{children:"Ciri's intelligence is not monolithic \u2014 it is assembled from a layered middleware stack that transforms every agent turn. Each middleware wraps the LLM call to inject context, enforce safety, manage state, or add capabilities."}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsx)(s.h2,{id:"overview",children:"Overview"}),"\n",(0,n.jsx)(s.mermaid,{value:"flowchart TD\n  User([User Message]) --\x3e M7[InjectNamesMiddleware]\n  M7 --\x3e M1[MemoryMiddleware]\n  M1 --\x3e M2[SkillsMiddleware]\n  M2 --\x3e M3[SubAgentMiddleware]\n  M3 --\x3e M4[ToolkitInjectionMiddleware]\n  M4 --\x3e M5[HumanInTheLoopMiddleware]\n  M5 --\x3e M6[TodoListMiddleware]\n  M6 --\x3e LLM([LLM Call])\n  LLM --\x3e M8[ToolRetryMiddleware]\n  M8 --\x3e M9[PatchToolCallsMiddleware]\n  M9 --\x3e Out([Response])"}),"\n",(0,n.jsxs)(s.p,{children:["Middlewares are composed in ",(0,n.jsx)(s.code,{children:"src/copilot.py"})," via ",(0,n.jsx)(s.code,{children:"create_copilot()"}),"."]}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsx)(s.h2,{id:"middleware-reference",children:"Middleware Reference"}),"\n",(0,n.jsxs)(s.h3,{id:"1-memorymiddleware",children:["1. ",(0,n.jsx)(s.code,{children:"MemoryMiddleware"})]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Source"}),": ",(0,n.jsx)(s.code,{children:"src/middlewares/memory.py"})]}),"\n",(0,n.jsxs)(s.p,{children:["Injects all ",(0,n.jsx)(s.code,{children:".md"})," files from the two-level memory system into the system prompt on every turn."]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Load order"})," (additive \u2014 both are injected):"]}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.code,{children:"~/.local/share/ciri/memory/"})," \u2014 cross-project global memory"]}),"\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.code,{children:".ciri/memory/"})," \u2014 this workspace's memory (AGENT.md, architecture.md, etc.)"]}),"\n"]}),"\n",(0,n.jsxs)(s.p,{children:["Ciri is instructed to read ",(0,n.jsx)(s.code,{children:".ciri/memory/AGENT.md"})," at the start of complex tasks \u2014 it is the workspace index. After significant work, Ciri updates these files to maintain continuity across sessions."]}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsxs)(s.h3,{id:"2-skillsmiddleware",children:["2. ",(0,n.jsx)(s.code,{children:"SkillsMiddleware"})]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Source"}),": ",(0,n.jsx)(s.code,{children:"src/middlewares/skills.py"})]}),"\n",(0,n.jsx)(s.p,{children:"Discovers skill packages from the two-level harness and dynamically injects their tools into Ciri's toolset."}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Discovery order"}),":"]}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsxs)(s.li,{children:["Core harness skills (",(0,n.jsx)(s.code,{children:"~/.local/share/ciri/skills/"}),")"]}),"\n",(0,n.jsxs)(s.li,{children:["Project harness skills (",(0,n.jsx)(s.code,{children:".ciri/skills/"}),")"]}),"\n"]}),"\n",(0,n.jsxs)(s.p,{children:["On first startup, ",(0,n.jsx)(s.code,{children:"_bootstrap_default_skills()"})," copies bundled skills from ",(0,n.jsx)(s.code,{children:"src/skills/"})," into the core harness. If a skill name exists in both harness levels, the core harness version takes precedence."]}),"\n",(0,n.jsxs)(s.p,{children:["Skills are ",(0,n.jsx)(s.strong,{children:"hot-reloaded"})," \u2014 adding a new skill folder and running ",(0,n.jsx)(s.code,{children:"/sync"})," registers it immediately without restart."]}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsxs)(s.h3,{id:"3-subagentmiddleware",children:["3. ",(0,n.jsx)(s.code,{children:"SubAgentMiddleware"})]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Source"}),": ",(0,n.jsx)(s.code,{children:"src/middlewares/subagents.py"})]}),"\n",(0,n.jsx)(s.p,{children:"Manages a registry of specialized subagents and enables delegation. When Ciri determines that a task fits a subagent's role, she hands off the request."}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Discovery order"}),":"]}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsxs)(s.li,{children:["Core harness subagents (",(0,n.jsx)(s.code,{children:"~/.local/share/ciri/subagents/*.yaml"}),")"]}),"\n",(0,n.jsxs)(s.li,{children:["Project harness subagents (",(0,n.jsx)(s.code,{children:".ciri/subagents/*.yaml"}),")"]}),"\n"]}),"\n",(0,n.jsxs)(s.p,{children:["Deduplication is by ",(0,n.jsx)(s.strong,{children:"file stem"})," \u2014 a core harness file named ",(0,n.jsx)(s.code,{children:"researcher.yaml"})," prevents a project file ",(0,n.jsx)(s.code,{children:"researcher.yaml"})," from registering."]}),"\n",(0,n.jsx)(s.p,{children:"Built-in subagents (web_researcher, skill_builder, toolkit_builder, subagent_builder, trainer_agent) are always registered as compiled subagents regardless of config files."}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsxs)(s.h3,{id:"4-toolkitinjectionmiddleware",children:["4. ",(0,n.jsx)(s.code,{children:"ToolkitInjectionMiddleware"})]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Source"}),": ",(0,n.jsx)(s.code,{children:"src/middlewares/toolkits.py"})]}),"\n",(0,n.jsx)(s.p,{children:"Acts as an MCP client that discovers and connects to MCP servers. Injects the MCP server's tools into Ciri's toolset dynamically, enabling hot-swap without restart."}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Discovery order"})," (ordered dict, first-wins):"]}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsxs)(s.li,{children:["Core harness toolkits (",(0,n.jsx)(s.code,{children:"~/.local/share/ciri/toolkits/"}),")"]}),"\n",(0,n.jsxs)(s.li,{children:["Project harness toolkits (",(0,n.jsx)(s.code,{children:".ciri/toolkits/"}),")"]}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:"Each toolkit directory contains a manifest and the MCP server process configuration. The middleware spawns the server subprocess and registers its tools into the active toolset."}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsxs)(s.h3,{id:"5-humanintheloopmiddleware",children:["5. ",(0,n.jsx)(s.code,{children:"HumanInTheLoopMiddleware"})]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Source"}),": ",(0,n.jsx)(s.code,{children:"langchain.agents.middleware"})," (deepagents library)"]}),"\n",(0,n.jsxs)(s.p,{children:["The mandatory safety gate. Intercepts configured tool calls before execution and issues a ",(0,n.jsx)(s.code,{children:"GraphInterrupt"})," that surfaces as an approval prompt in the CLI."]}),"\n",(0,n.jsxs)(s.p,{children:["Default interrupt triggers: ",(0,n.jsx)(s.code,{children:"execute"}),", ",(0,n.jsx)(s.code,{children:"edit_file"}),", ",(0,n.jsx)(s.code,{children:"write_file"}),"."]}),"\n",(0,n.jsx)(s.p,{children:"The interrupt payload includes the tool name, description, and full JSON arguments \u2014 displayed as a Rich panel with syntax highlighting."}),"\n",(0,n.jsxs)(s.p,{children:["\u2192 ",(0,n.jsx)(s.a,{href:"/docs/features/hitl",children:"HITL Guide"})]}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsxs)(s.h3,{id:"6-todolistmiddleware",children:["6. ",(0,n.jsx)(s.code,{children:"TodoListMiddleware"})]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Source"}),": ",(0,n.jsx)(s.code,{children:"langchain.agents.middleware"})," (deepagents library)"]}),"\n",(0,n.jsx)(s.p,{children:"Maintains a structured to-do list across a multi-step task. Before each LLM call, injects the current task state into the context so Ciri can plan and track progress through complex, long-running jobs."}),"\n",(0,n.jsxs)(s.p,{children:["Particularly useful for ",(0,n.jsx)(s.code,{children:"/sync"})," runs (which may involve dozens of steps) and long coding sessions."]}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsxs)(s.h3,{id:"7-injectavailabletoolnamesmiddleware",children:["7. ",(0,n.jsx)(s.code,{children:"InjectAvailableToolNamesMiddleware"})]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Source"}),": ",(0,n.jsx)(s.code,{children:"src/middlewares/inject_names.py"})]}),"\n",(0,n.jsx)(s.p,{children:"Injects a formatted list of ALL currently available tool names into the system prompt. This is critical for the subagent builder \u2014 when creating a new subagent config, Ciri needs to know what tools exist so she can assign the right ones."}),"\n",(0,n.jsx)(s.p,{children:"Injection format:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{children:"# REGISTRY OF AVAILABLE TOOLS\nCRITICAL: You MUST ONLY select tools from the following list...\n\n- **write_file**: Write content to a file at the given path\n- **execute**: Execute a shell command\n- **web_crawler**: High-performance web crawler for extracting markdown...\n...\n"})}),"\n",(0,n.jsx)(s.p,{children:"Prevents duplicate injection across retries (checks for header before injecting)."}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsxs)(s.h3,{id:"8-injectavailablesubagentnamesmiddleware",children:["8. ",(0,n.jsx)(s.code,{children:"InjectAvailableSubAgentNamesMiddleware"})]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Source"}),": ",(0,n.jsx)(s.code,{children:"src/middlewares/inject_names.py"})]}),"\n",(0,n.jsx)(s.p,{children:"Injects a list of all currently registered subagent names into the system prompt. Ensures Ciri's routing decisions reference only subagents that actually exist."}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsxs)(s.h3,{id:"9-injectavailableskillnamesmiddleware",children:["9. ",(0,n.jsx)(s.code,{children:"InjectAvailableSkillNamesMiddleware"})]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Source"}),": ",(0,n.jsx)(s.code,{children:"src/middlewares/inject_names.py"})]}),"\n",(0,n.jsx)(s.p,{children:"Injects a list of all loaded skill names. Helps Ciri avoid attempting to use skills that aren't loaded yet and also informs the trainer agent what already exists before proposing new skills."}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsxs)(s.h3,{id:"10-toolretrymiddleware",children:["10. ",(0,n.jsx)(s.code,{children:"ToolRetryMiddleware"})]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Source"}),": ",(0,n.jsx)(s.code,{children:"langchain.agents.middleware"})," (deepagents library)"]}),"\n",(0,n.jsx)(s.p,{children:"Wraps tool calls in a retry loop with configurable retry count and backoff. By default, retries up to 3 times on tool execution failures."}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Critical behavior"}),": Uses ",(0,n.jsx)(s.code,{children:"retry_on=lambda exc: not isinstance(exc, GraphInterrupt)"})," \u2014 HITL interrupts are never retried. This prevents the bug where Ciri would retry 3 times before failing on an approval prompt."]}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsxs)(s.h3,{id:"11-patchtoolcallsmiddleware",children:["11. ",(0,n.jsx)(s.code,{children:"PatchToolCallsMiddleware"})]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Source"}),": ",(0,n.jsx)(s.code,{children:"deepagents.middleware.patch_tool_calls"})," (deepagents library)"]}),"\n",(0,n.jsx)(s.p,{children:"Normalizes tool call formats for consistency across different LLM providers. Different models (OpenAI, Anthropic, etc.) may produce tool call payloads in slightly different schemas \u2014 this middleware normalizes them before they hit the tool execution layer."}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsxs)(s.h3,{id:"12-filesystemmiddleware",children:["12. ",(0,n.jsx)(s.code,{children:"FilesystemMiddleware"})]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Source"}),": ",(0,n.jsx)(s.code,{children:"deepagents.middleware.filesystem"})," (deepagents library)"]}),"\n",(0,n.jsxs)(s.p,{children:["Provides scoped, safe filesystem access. Injects the workspace root path and constrains all file operations to the configured root unless explicitly overridden. Adds ",(0,n.jsx)(s.code,{children:"read_file"}),", ",(0,n.jsx)(s.code,{children:"write_file"}),", ",(0,n.jsx)(s.code,{children:"edit_file"}),", ",(0,n.jsx)(s.code,{children:"list_dir"}),", and related tools."]}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsxs)(s.h3,{id:"13-summarizationmiddleware",children:["13. ",(0,n.jsx)(s.code,{children:"SummarizationMiddleware"})]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Source"}),": ",(0,n.jsx)(s.code,{children:"deepagents.middleware.summarization"})," (deepagents library)"]}),"\n",(0,n.jsx)(s.p,{children:"Monitors context length and proactively summarizes long conversation threads when they approach the model's context window limit. Preserves critical information while compressing verbose tool outputs."}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsxs)(s.h3,{id:"14-anthropicpromptcachingmiddleware",children:["14. ",(0,n.jsx)(s.code,{children:"AnthropicPromptCachingMiddleware"})]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.strong,{children:"Source"}),": ",(0,n.jsx)(s.code,{children:"langchain_anthropic.middleware"})]}),"\n",(0,n.jsx)(s.p,{children:"When using Anthropic models, this middleware automatically applies prompt caching markers to static portions of the system prompt (base instructions, memory, skill lists). Dramatically reduces token cost and latency for long sessions."}),"\n",(0,n.jsx)(s.hr,{}),"\n",(0,n.jsx)(s.h2,{id:"adding-custom-middleware",children:"Adding Custom Middleware"}),"\n",(0,n.jsxs)(s.p,{children:["Extend ",(0,n.jsx)(s.code,{children:"AgentMiddleware"})," from the deepagents library:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-python",children:'from langchain.agents.middleware import AgentMiddleware\n\nclass MyCustomMiddleware(AgentMiddleware):\n    def wrap_model_call(self, request, handler):\n        # Modify request before LLM call\n        request.system_prompt += "\\n\\nMy custom context..."\n        response = handler(request)\n        # Post-process response\n        return response\n'})}),"\n",(0,n.jsxs)(s.p,{children:["Then pass it to ",(0,n.jsx)(s.code,{children:"create_copilot()"}),":"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-python",children:"graph = await create_copilot(\n    middleware=[MyCustomMiddleware()]\n)\n"})})]})}function h(e={}){const{wrapper:s}={...(0,l.R)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(c,{...e})}):c(e)}},8453(e,s,r){r.d(s,{R:()=>d,x:()=>t});var i=r(6540);const n={},l=i.createContext(n);function d(e){const s=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function t(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:d(e.components),i.createElement(l.Provider,{value:s},e.children)}}}]);