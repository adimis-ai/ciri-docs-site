"use strict";(self.webpackChunkciri_docs=self.webpackChunkciri_docs||[]).push([[1868],{6(e,n,r){r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"internals/graph-execution","title":"Graph Execution & Agent Boot","description":"This page traces exactly how Ciri is constructed and executed at runtime \u2014 from the moment ciri is run in the terminal to the first token streaming back. Reference this when adding middlewares, subagents, or custom tools.","source":"@site/docs/internals/graph-execution.md","sourceDirName":"internals","slug":"/internals/graph-execution","permalink":"/docs/internals/graph-execution","draft":false,"unlisted":false,"editUrl":"https://github.com/adimis-ai/ciri/tree/main/docs-site/docs/internals/graph-execution.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Self-Evolution & Training","permalink":"/docs/internals/self-evolution"},"next":{"title":"Roadmap","permalink":"/docs/roadmap"}}');var t=r(4848),s=r(8453);const a={},l="Graph Execution & Agent Boot",o={},d=[{value:"Boot Sequence",id:"boot-sequence",level:2},{value:"Key Entry Points",id:"key-entry-points",level:2},{value:"LangGraph State Graph",id:"langgraph-state-graph",level:2},{value:"Full Middleware Reference | Controller Reference",id:"full-middleware-reference--controller-reference",level:2},{value:"Middleware Wrapping",id:"middleware-wrapping",level:2},{value:"Interrupt Handling",id:"interrupt-handling",level:2},{value:"Thread State and Persistence",id:"thread-state-and-persistence",level:2},{value:"Streaming Architecture in the CLI",id:"streaming-architecture-in-the-cli",level:2},{value:"Adding a New Tool",id:"adding-a-new-tool",level:2},{value:"Adding a New Subagent",id:"adding-a-new-subagent",level:2},{value:"Practical Debugging Tips",id:"practical-debugging-tips",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"graph-execution--agent-boot",children:"Graph Execution & Agent Boot"})}),"\n",(0,t.jsxs)(n.p,{children:["This page traces exactly how Ciri is constructed and executed at runtime \u2014 from the moment ",(0,t.jsx)(n.code,{children:"ciri"})," is run in the terminal to the first token streaming back. Reference this when adding middlewares, subagents, or custom tools."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"boot-sequence",children:"Boot Sequence"}),"\n",(0,t.jsx)(n.mermaid,{value:"sequenceDiagram\n  autonumber\n  participant Shell as Terminal\n  participant Main as src/__main__.py\n  participant Copilot as src/copilot.py\n  participant LLM as LangChain Model\n  participant Browser as Browser/CDP\n  participant Builders as Subagent Builders\n  participant MW as Middleware Stack\n  participant LG as LangGraph\n\n  Shell->>Main: ciri (CLI entrypoint)\n  Main->>Main: ensure_playwright_installed()\n  Main->>Main: load API config from env\n  Main->>Copilot: create_copilot(config)\n  Copilot->>LLM: llm_config.init_langchain_model()\n  LLM--\x3e>Copilot: model instance\n  Copilot->>Browser: resolve_browser_profile() \u2192 launch_browser_with_cdp()\n  Browser--\x3e>Copilot: cdp_url (or None if no browser)\n  Copilot->>Builders: build_web_researcher_agent(model, cdp_url)\n  Builders--\x3e>Copilot: web_researcher\n  Copilot->>Builders: build_skill_builder_agent(web_researcher)\n  Builders--\x3e>Copilot: skill_builder\n  Copilot->>Builders: build_toolkit_builder_agent(web_researcher)\n  Builders--\x3e>Copilot: toolkit_builder\n  Copilot->>Builders: build_subagent_builder_agent(web_researcher)\n  Builders--\x3e>Copilot: subagent_builder\n  Copilot->>Builders: build_trainer_agent(all_builders)\n  Builders--\x3e>Copilot: trainer_agent\n  Copilot->>MW: assemble middleware stack (14 layers)\n  MW--\x3e>Copilot: configured stack\n  Copilot->>LG: compile state graph\n  LG--\x3e>Copilot: CompiledStateGraph\n  Copilot--\x3e>Main: graph\n  Main->>Main: wrap with CiriController\n  Main->>Main: start REPL (prompt_toolkit session)"}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"key-entry-points",children:"Key Entry Points"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Function"}),(0,t.jsx)(n.th,{children:"File"}),(0,t.jsx)(n.th,{children:"Purpose"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"main()"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"src/__main__.py"})}),(0,t.jsx)(n.td,{children:"CLI entry, startup sequence, REPL loop"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"create_copilot()"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"src/copilot.py"})}),(0,t.jsx)(n.td,{children:"Assembles the full LangGraph graph"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CopilotController.run()"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"src/controller.py"})}),(0,t.jsx)(n.td,{children:"Streams events from graph for a given input"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CopilotController.get_state()"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"src/controller.py"})}),(0,t.jsx)(n.td,{children:"Returns current graph checkpoint state"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"llm_config.init_langchain_model()"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"src/llm_config.py"})}),(0,t.jsx)(n.td,{children:"Initializes LangChain model from config"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ensure_playwright_installed()"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"src/__main__.py"})}),(0,t.jsxs)(n.td,{children:["Runs ",(0,t.jsx)(n.code,{children:"playwright install chromium"})," silently"]})]})]})]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"langgraph-state-graph",children:"LangGraph State Graph"}),"\n",(0,t.jsxs)(n.p,{children:["Ciri uses a ",(0,t.jsx)(n.code,{children:"StateGraph"})," compiled with:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"State schema"})," \u2014 typed state dict carrying messages, checkpoints, and metadata"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Nodes"})," \u2014 the main Ciri agent node + tool execution nodes"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Edges"})," \u2014 conditional routing based on whether the LLM called a tool or finished"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Checkpointers"})," \u2014 ",(0,t.jsx)(n.code,{children:"AsyncSqliteSaver"})," backed by ",(0,t.jsx)(n.code,{children:"~/.ciri/data/ciri.db"})," for persistence across sessions"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["The graph runs in ",(0,t.jsx)(n.strong,{children:"streaming mode"})," using ",(0,t.jsx)(n.code,{children:"astream()"})," with two streaming modes:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'stream_modes = ["updates", "messages"]\n'})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:'"updates"'})," \u2014 emits node state after each graph step; carries interrupt signals"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:'"messages"'})," \u2014 emits ",(0,t.jsx)(n.code,{children:"AIMessageChunk"})," objects for token-by-token streaming"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsxs)(n.h2,{id:"full-middleware-reference--controller-reference",children:[(0,t.jsx)(n.a,{href:"/docs/internals/middlewares",children:"Full Middleware Reference"})," | ",(0,t.jsx)(n.a,{href:"/docs/internals/controller",children:"Controller Reference"})]}),"\n",(0,t.jsx)(n.h2,{id:"middleware-wrapping",children:"Middleware Wrapping"}),"\n",(0,t.jsxs)(n.p,{children:["Each middleware wraps the LLM call via ",(0,t.jsx)(n.code,{children:"wrap_model_call"}),". The stack processes requests inward and responses outward:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"User input\n  \u2192 InjectNamesMiddleware     (inject tool/skill/subagent registries)\n  \u2192 MemoryMiddleware          (inject memory files)\n  \u2192 SkillsMiddleware          (inject active skill context)\n  \u2192 SubAgentMiddleware        (inject subagent routing logic)\n  \u2192 ToolkitInjectionMiddleware (connect MCP servers)\n  \u2192 HumanInTheLoopMiddleware  (intercept for approval)\n  \u2192 TodoListMiddleware        (inject task state)\n  \u2192 LLM call\n  \u2192 ToolRetryMiddleware       (retry failed tools, skip GraphInterrupt)\n  \u2192 PatchToolCallsMiddleware  (normalize tool call format)\n  \u2192 Response\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Middlewares are assembled in ",(0,t.jsx)(n.code,{children:"create_copilot()"})," via ",(0,t.jsx)(n.code,{children:"MiddlewareBuilder"}),". The order is significant \u2014 middlewares added first wrap the outermost layer."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"interrupt-handling",children:"Interrupt Handling"}),"\n",(0,t.jsxs)(n.p,{children:["When ",(0,t.jsx)(n.code,{children:"HumanInTheLoopMiddleware"})," triggers, it raises ",(0,t.jsx)(n.code,{children:"GraphInterrupt"}),". This exception surfaces through ",(0,t.jsx)(n.code,{children:"astream()"})," as a special event type:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'async for event in graph.astream(input, config, stream_mode=["updates", "messages"]):\n    if isinstance(event, GraphInterrupt):\n        # Surface approval prompt to user\n        handle_interrupts(event)\n'})}),"\n",(0,t.jsx)(n.p,{children:"After the user responds (approve/edit/reject), execution resumes with:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"await graph.astream(Command(resume=decision), config)\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"ToolRetryMiddleware"})," is configured with ",(0,t.jsx)(n.code,{children:"retry_on=lambda exc: not isinstance(exc, GraphInterrupt)"})," to prevent retrying approval prompts."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"thread-state-and-persistence",children:"Thread State and Persistence"}),"\n",(0,t.jsxs)(n.p,{children:["Each conversation thread maps to a LangGraph ",(0,t.jsx)(n.strong,{children:"config"})," with a unique ",(0,t.jsx)(n.code,{children:"thread_id"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'config = {"configurable": {"thread_id": thread_id}}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["LangGraph's ",(0,t.jsx)(n.code,{children:"AsyncSqliteSaver"})," checkpointer writes the full state (messages + metadata) to ",(0,t.jsx)(n.code,{children:"~/.ciri/data/ciri.db"})," after each graph step. Resuming a thread replays from the latest checkpoint."]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"threads"})," table in the same database stores human-readable metadata (name, created_at, last_updated) alongside the LangGraph checkpoint data."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"streaming-architecture-in-the-cli",children:"Streaming Architecture in the CLI"}),"\n",(0,t.jsx)(n.mermaid,{value:'sequenceDiagram\n  participant REPL as REPL (main thread)\n  participant Ctrl as CiriController\n  participant Graph as LangGraph graph\n  participant Rich as Rich Console\n\n  REPL->>Ctrl: stream(input, thread_id)\n  Ctrl->>Graph: astream(input, config, stream_mode=["updates","messages"])\n  loop Token streaming\n    Graph--\x3e>Ctrl: AIMessageChunk\n    Ctrl--\x3e>REPL: yield chunk\n    REPL->>Rich: print chunk (live update)\n  end\n  loop Node updates\n    Graph--\x3e>Ctrl: node state update\n    Ctrl--\x3e>REPL: yield update\n    REPL->>REPL: check for GraphInterrupt\n  end\n  Graph--\x3e>Ctrl: stream complete\n  Ctrl--\x3e>REPL: done'}),"\n",(0,t.jsxs)(n.p,{children:["The REPL runs a synchronous loop calling ",(0,t.jsx)(n.code,{children:"controller.run()"}),". ",(0,t.jsx)(n.code,{children:"CopilotController.run()"})," runs the async ",(0,t.jsx)(n.code,{children:"astream()"})," in the event loop and yields events."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"adding-a-new-tool",children:"Adding a New Tool"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Define the tool function with LangChain ",(0,t.jsx)(n.code,{children:"@tool"})," decorator:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'from langchain.tools import tool\n\n@tool\ndef my_new_tool(input: str) -> str:\n    """One-sentence description of what this tool does."""\n    return f"Result: {input}"\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Register it in ",(0,t.jsx)(n.code,{children:"src/agent.py"})," inside ",(0,t.jsx)(n.code,{children:"_create_ciri()"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"tools = [\n    ...existing tools...,\n    my_new_tool,\n]\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["If the tool needs HITL approval, add it to ",(0,t.jsx)(n.code,{children:"interrupt_on"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'interrupt_on = {"execute": True, "edit_file": True, "write_file": True, "my_new_tool": True}\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"InjectAvailableToolNamesMiddleware"})," will automatically include it in the registry injection on the next run."]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"adding-a-new-subagent",children:"Adding a New Subagent"}),"\n",(0,t.jsxs)(n.p,{children:["See the full ",(0,t.jsx)(n.a,{href:"/docs/subagents-guide",children:"Subagents Guide"}),". At the graph level:"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Implement the builder function (e.g., ",(0,t.jsx)(n.code,{children:"build_my_subagent()"}),") in ",(0,t.jsx)(n.code,{children:"src/subagents/my_subagent.py"})]}),"\n",(0,t.jsxs)(n.li,{children:["Register in ",(0,t.jsx)(n.code,{children:"create_copilot()"})," alongside the other builder calls"]}),"\n",(0,t.jsxs)(n.li,{children:["Pass it to ",(0,t.jsx)(n.code,{children:"SubAgentMiddleware"})," so Ciri can delegate to it"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"InjectAvailableSubAgentNamesMiddleware"})," will automatically include it in the name injection"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"practical-debugging-tips",children:"Practical Debugging Tips"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Trace graph compilation:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"# In a test or scratch script\nimport asyncio\nfrom src.copilot import create_copilot\n\ngraph = asyncio.run(create_copilot(...))\nprint(graph.get_graph().draw_ascii())\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Inspect checkpoint state:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'from src.controller import CopilotController\n\nctrl = CopilotController(graph)\nstate = asyncio.run(ctrl.get_state(thread_id="my-thread"))\nprint(state.values)\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Integration test pattern:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'import asyncio\nfrom src.copilot import create_copilot\nfrom src.controller import CiriController\n\nasync def test_basic_flow():\n    graph = await create_copilot(model="claude-haiku-4-5-20251001")\n    ctrl = CopilotController(graph)\n    thread_id = "test-thread"\n\n    results = []\n    async for event in ctrl.run("Hello", thread_id):\n        results.append(event)\n\n    assert any("Hello" in str(r) for r in results)\n'})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},8453(e,n,r){r.d(n,{R:()=>a,x:()=>l});var i=r(6540);const t={},s=i.createContext(t);function a(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);