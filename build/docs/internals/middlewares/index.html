<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-internals/middlewares" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Middleware Stack | Ciri</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ciri.adimis.in/docs/internals/middlewares"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Middleware Stack | Ciri"><meta data-rh="true" name="description" content="Ciri&#x27;s intelligence is not monolithic — it is assembled from a layered middleware stack that transforms every agent turn. Each middleware wraps the LLM call to inject context, enforce safety, manage state, or add capabilities."><meta data-rh="true" property="og:description" content="Ciri&#x27;s intelligence is not monolithic — it is assembled from a layered middleware stack that transforms every agent turn. Each middleware wraps the LLM call to inject context, enforce safety, manage state, or add capabilities."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ciri.adimis.in/docs/internals/middlewares"><link data-rh="true" rel="alternate" href="https://ciri.adimis.in/docs/internals/middlewares" hreflang="en"><link data-rh="true" rel="alternate" href="https://ciri.adimis.in/docs/internals/middlewares" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Middleware Stack","item":"https://ciri.adimis.in/docs/internals/middlewares"}]}</script><link rel="stylesheet" href="/assets/css/styles.3fe6f9ad.css">
<script src="/assets/js/runtime~main.19b8b2d8.js" defer="defer"></script>
<script src="/assets/js/main.6535abe5.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Ciri</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/getting-started">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/built-in-skills/">Skills</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/roadmap">Roadmap</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/adimis-ai/ciri" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/"><span title="Introduction" class="linkLabel_WmDU">Introduction</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/getting-started"><span title="Getting Started" class="linkLabel_WmDU">Getting Started</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/docs/cli-reference"><span title="CLI Reference" class="categoryLinkLabel_W154">CLI Reference</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cli-reference"><span title="CLI Reference" class="linkLabel_WmDU">CLI Reference</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/examples"><span title="Examples &amp; Tutorials" class="linkLabel_WmDU">Examples &amp; Tutorials</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/docs/features/memory"><span title="Features" class="categoryLinkLabel_W154">Features</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/features/memory"><span title="Persistent Workspace Memory" class="linkLabel_WmDU">Persistent Workspace Memory</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/features/hitl"><span title="Human-in-the-Loop (HITL)" class="linkLabel_WmDU">Human-in-the-Loop (HITL)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/features/autocomplete"><span title="Autocomplete &amp; Context Triggers" class="linkLabel_WmDU">Autocomplete &amp; Context Triggers</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/features/web-research"><span title="Deep Web Research" class="linkLabel_WmDU">Deep Web Research</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/features/script-executor"><span title="Script Executor" class="linkLabel_WmDU">Script Executor</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/docs/built-in-skills/"><span title="Skills" class="categoryLinkLabel_W154">Skills</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/built-in-skills/"><span title="Built-in Skills" class="linkLabel_WmDU">Built-in Skills</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/skills-guide"><span title="Skills Guide" class="linkLabel_WmDU">Skills Guide</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/toolkits-guide"><span title="Toolkits &amp; Subagents" class="categoryLinkLabel_W154">Toolkits &amp; Subagents</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/architecture/overview"><span title="Architecture" class="categoryLinkLabel_W154">Architecture</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/internals/controller"><span title="Internals" class="categoryLinkLabel_W154">Internals</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/internals/controller"><span title="Copilot Controller" class="linkLabel_WmDU">Copilot Controller</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/internals/middlewares"><span title="Middleware Stack" class="linkLabel_WmDU">Middleware Stack</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/internals/self-evolution"><span title="Self-Evolution &amp; Training" class="linkLabel_WmDU">Self-Evolution &amp; Training</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/internals/graph-execution"><span title="Graph Execution &amp; Agent Boot" class="linkLabel_WmDU">Graph Execution &amp; Agent Boot</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/roadmap"><span title="Project" class="categoryLinkLabel_W154">Project</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Internals</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Middleware Stack</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Middleware Stack</h1></header>
<p>Ciri&#x27;s intelligence is not monolithic — it is assembled from a layered middleware stack that transforms every agent turn. Each middleware wraps the LLM call to inject context, enforce safety, manage state, or add capabilities.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" translate="no">​</a></h2>
<!-- -->
<p>Middlewares are composed in <code>src/copilot.py</code> via <code>create_copilot()</code>.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="middleware-reference">Middleware Reference<a href="#middleware-reference" class="hash-link" aria-label="Direct link to Middleware Reference" title="Direct link to Middleware Reference" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-memorymiddleware">1. <code>MemoryMiddleware</code><a href="#1-memorymiddleware" class="hash-link" aria-label="Direct link to 1-memorymiddleware" title="Direct link to 1-memorymiddleware" translate="no">​</a></h3>
<p><strong>Source</strong>: <code>src/middlewares/memory.py</code></p>
<p>Injects all <code>.md</code> files from the two-level memory system into the system prompt on every turn.</p>
<p><strong>Load order</strong> (additive — both are injected):</p>
<ol>
<li class=""><code>~/.local/share/ciri/memory/</code> — cross-project global memory</li>
<li class=""><code>.ciri/memory/</code> — this workspace&#x27;s memory (AGENT.md, architecture.md, etc.)</li>
</ol>
<p>Ciri is instructed to read <code>.ciri/memory/AGENT.md</code> at the start of complex tasks — it is the workspace index. After significant work, Ciri updates these files to maintain continuity across sessions.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-skillsmiddleware">2. <code>SkillsMiddleware</code><a href="#2-skillsmiddleware" class="hash-link" aria-label="Direct link to 2-skillsmiddleware" title="Direct link to 2-skillsmiddleware" translate="no">​</a></h3>
<p><strong>Source</strong>: <code>src/middlewares/skills.py</code></p>
<p>Discovers skill packages from the two-level harness and dynamically injects their tools into Ciri&#x27;s toolset.</p>
<p><strong>Discovery order</strong>:</p>
<ol>
<li class="">Core harness skills (<code>~/.local/share/ciri/skills/</code>)</li>
<li class="">Project harness skills (<code>.ciri/skills/</code>)</li>
</ol>
<p>On first startup, <code>_bootstrap_default_skills()</code> copies bundled skills from <code>src/skills/</code> into the core harness. If a skill name exists in both harness levels, the core harness version takes precedence.</p>
<p>Skills are <strong>hot-reloaded</strong> — adding a new skill folder and running <code>/sync</code> registers it immediately without restart.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-subagentmiddleware">3. <code>SubAgentMiddleware</code><a href="#3-subagentmiddleware" class="hash-link" aria-label="Direct link to 3-subagentmiddleware" title="Direct link to 3-subagentmiddleware" translate="no">​</a></h3>
<p><strong>Source</strong>: <code>src/middlewares/subagents.py</code></p>
<p>Manages a registry of specialized subagents and enables delegation. When Ciri determines that a task fits a subagent&#x27;s role, she hands off the request.</p>
<p><strong>Discovery order</strong>:</p>
<ol>
<li class="">Core harness subagents (<code>~/.local/share/ciri/subagents/*.yaml</code>)</li>
<li class="">Project harness subagents (<code>.ciri/subagents/*.yaml</code>)</li>
</ol>
<p>Deduplication is by <strong>file stem</strong> — a core harness file named <code>researcher.yaml</code> prevents a project file <code>researcher.yaml</code> from registering.</p>
<p>Built-in subagents (web_researcher, skill_builder, toolkit_builder, subagent_builder, trainer_agent) are always registered as compiled subagents regardless of config files.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-toolkitinjectionmiddleware">4. <code>ToolkitInjectionMiddleware</code><a href="#4-toolkitinjectionmiddleware" class="hash-link" aria-label="Direct link to 4-toolkitinjectionmiddleware" title="Direct link to 4-toolkitinjectionmiddleware" translate="no">​</a></h3>
<p><strong>Source</strong>: <code>src/middlewares/toolkits.py</code></p>
<p>Acts as an MCP client that discovers and connects to MCP servers. Injects the MCP server&#x27;s tools into Ciri&#x27;s toolset dynamically, enabling hot-swap without restart.</p>
<p><strong>Discovery order</strong> (ordered dict, first-wins):</p>
<ol>
<li class="">Core harness toolkits (<code>~/.local/share/ciri/toolkits/</code>)</li>
<li class="">Project harness toolkits (<code>.ciri/toolkits/</code>)</li>
</ol>
<p>Each toolkit directory contains a manifest and the MCP server process configuration. The middleware spawns the server subprocess and registers its tools into the active toolset.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-humanintheloopmiddleware">5. <code>HumanInTheLoopMiddleware</code><a href="#5-humanintheloopmiddleware" class="hash-link" aria-label="Direct link to 5-humanintheloopmiddleware" title="Direct link to 5-humanintheloopmiddleware" translate="no">​</a></h3>
<p><strong>Source</strong>: <code>langchain.agents.middleware</code> (deepagents library)</p>
<p>The mandatory safety gate. Intercepts configured tool calls before execution and issues a <code>GraphInterrupt</code> that surfaces as an approval prompt in the CLI.</p>
<p>Default interrupt triggers: <code>execute</code>, <code>edit_file</code>, <code>write_file</code>.</p>
<p>The interrupt payload includes the tool name, description, and full JSON arguments — displayed as a Rich panel with syntax highlighting.</p>
<p>→ <a class="" href="/docs/features/hitl">HITL Guide</a></p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="6-todolistmiddleware">6. <code>TodoListMiddleware</code><a href="#6-todolistmiddleware" class="hash-link" aria-label="Direct link to 6-todolistmiddleware" title="Direct link to 6-todolistmiddleware" translate="no">​</a></h3>
<p><strong>Source</strong>: <code>langchain.agents.middleware</code> (deepagents library)</p>
<p>Maintains a structured to-do list across a multi-step task. Before each LLM call, injects the current task state into the context so Ciri can plan and track progress through complex, long-running jobs.</p>
<p>Particularly useful for <code>/sync</code> runs (which may involve dozens of steps) and long coding sessions.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="7-injectavailabletoolnamesmiddleware">7. <code>InjectAvailableToolNamesMiddleware</code><a href="#7-injectavailabletoolnamesmiddleware" class="hash-link" aria-label="Direct link to 7-injectavailabletoolnamesmiddleware" title="Direct link to 7-injectavailabletoolnamesmiddleware" translate="no">​</a></h3>
<p><strong>Source</strong>: <code>src/middlewares/inject_names.py</code></p>
<p>Injects a formatted list of ALL currently available tool names into the system prompt. This is critical for the subagent builder — when creating a new subagent config, Ciri needs to know what tools exist so she can assign the right ones.</p>
<p>Injection format:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># REGISTRY OF AVAILABLE TOOLS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CRITICAL: You MUST ONLY select tools from the following list...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- **write_file**: Write content to a file at the given path</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- **execute**: Execute a shell command</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- **web_crawler**: High-performance web crawler for extracting markdown...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span></code></pre></div></div>
<p>Prevents duplicate injection across retries (checks for header before injecting).</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="8-injectavailablesubagentnamesmiddleware">8. <code>InjectAvailableSubAgentNamesMiddleware</code><a href="#8-injectavailablesubagentnamesmiddleware" class="hash-link" aria-label="Direct link to 8-injectavailablesubagentnamesmiddleware" title="Direct link to 8-injectavailablesubagentnamesmiddleware" translate="no">​</a></h3>
<p><strong>Source</strong>: <code>src/middlewares/inject_names.py</code></p>
<p>Injects a list of all currently registered subagent names into the system prompt. Ensures Ciri&#x27;s routing decisions reference only subagents that actually exist.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="9-injectavailableskillnamesmiddleware">9. <code>InjectAvailableSkillNamesMiddleware</code><a href="#9-injectavailableskillnamesmiddleware" class="hash-link" aria-label="Direct link to 9-injectavailableskillnamesmiddleware" title="Direct link to 9-injectavailableskillnamesmiddleware" translate="no">​</a></h3>
<p><strong>Source</strong>: <code>src/middlewares/inject_names.py</code></p>
<p>Injects a list of all loaded skill names. Helps Ciri avoid attempting to use skills that aren&#x27;t loaded yet and also informs the trainer agent what already exists before proposing new skills.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="10-toolretrymiddleware">10. <code>ToolRetryMiddleware</code><a href="#10-toolretrymiddleware" class="hash-link" aria-label="Direct link to 10-toolretrymiddleware" title="Direct link to 10-toolretrymiddleware" translate="no">​</a></h3>
<p><strong>Source</strong>: <code>langchain.agents.middleware</code> (deepagents library)</p>
<p>Wraps tool calls in a retry loop with configurable retry count and backoff. By default, retries up to 3 times on tool execution failures.</p>
<p><strong>Critical behavior</strong>: Uses <code>retry_on=lambda exc: not isinstance(exc, GraphInterrupt)</code> — HITL interrupts are never retried. This prevents the bug where Ciri would retry 3 times before failing on an approval prompt.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="11-patchtoolcallsmiddleware">11. <code>PatchToolCallsMiddleware</code><a href="#11-patchtoolcallsmiddleware" class="hash-link" aria-label="Direct link to 11-patchtoolcallsmiddleware" title="Direct link to 11-patchtoolcallsmiddleware" translate="no">​</a></h3>
<p><strong>Source</strong>: <code>deepagents.middleware.patch_tool_calls</code> (deepagents library)</p>
<p>Normalizes tool call formats for consistency across different LLM providers. Different models (OpenAI, Anthropic, etc.) may produce tool call payloads in slightly different schemas — this middleware normalizes them before they hit the tool execution layer.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="12-filesystemmiddleware">12. <code>FilesystemMiddleware</code><a href="#12-filesystemmiddleware" class="hash-link" aria-label="Direct link to 12-filesystemmiddleware" title="Direct link to 12-filesystemmiddleware" translate="no">​</a></h3>
<p><strong>Source</strong>: <code>deepagents.middleware.filesystem</code> (deepagents library)</p>
<p>Provides scoped, safe filesystem access. Injects the workspace root path and constrains all file operations to the configured root unless explicitly overridden. Adds <code>read_file</code>, <code>write_file</code>, <code>edit_file</code>, <code>list_dir</code>, and related tools.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="13-summarizationmiddleware">13. <code>SummarizationMiddleware</code><a href="#13-summarizationmiddleware" class="hash-link" aria-label="Direct link to 13-summarizationmiddleware" title="Direct link to 13-summarizationmiddleware" translate="no">​</a></h3>
<p><strong>Source</strong>: <code>deepagents.middleware.summarization</code> (deepagents library)</p>
<p>Monitors context length and proactively summarizes long conversation threads when they approach the model&#x27;s context window limit. Preserves critical information while compressing verbose tool outputs.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="14-anthropicpromptcachingmiddleware">14. <code>AnthropicPromptCachingMiddleware</code><a href="#14-anthropicpromptcachingmiddleware" class="hash-link" aria-label="Direct link to 14-anthropicpromptcachingmiddleware" title="Direct link to 14-anthropicpromptcachingmiddleware" translate="no">​</a></h3>
<p><strong>Source</strong>: <code>langchain_anthropic.middleware</code></p>
<p>When using Anthropic models, this middleware automatically applies prompt caching markers to static portions of the system prompt (base instructions, memory, skill lists). Dramatically reduces token cost and latency for long sessions.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="adding-custom-middleware">Adding Custom Middleware<a href="#adding-custom-middleware" class="hash-link" aria-label="Direct link to Adding Custom Middleware" title="Direct link to Adding Custom Middleware" translate="no">​</a></h2>
<p>Extend <code>AgentMiddleware</code> from the deepagents library:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">agents</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">middleware </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> AgentMiddleware</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">MyCustomMiddleware</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">AgentMiddleware</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">wrap_model_call</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> handler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Modify request before LLM call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">system_prompt </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;\n\nMy custom context...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        response </span><span class="token operator">=</span><span class="token plain"> handler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Post-process response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> response</span><br></span></code></pre></div></div>
<p>Then pass it to <code>create_copilot()</code>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">graph </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> create_copilot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    middleware</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">MyCustomMiddleware</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/adimis-ai/ciri/tree/main/docs-site/docs/internals/middlewares.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/internals/controller"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Copilot Controller</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/internals/self-evolution"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Self-Evolution &amp; Training</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#middleware-reference" class="table-of-contents__link toc-highlight">Middleware Reference</a><ul><li><a href="#1-memorymiddleware" class="table-of-contents__link toc-highlight">1. <code>MemoryMiddleware</code></a></li><li><a href="#2-skillsmiddleware" class="table-of-contents__link toc-highlight">2. <code>SkillsMiddleware</code></a></li><li><a href="#3-subagentmiddleware" class="table-of-contents__link toc-highlight">3. <code>SubAgentMiddleware</code></a></li><li><a href="#4-toolkitinjectionmiddleware" class="table-of-contents__link toc-highlight">4. <code>ToolkitInjectionMiddleware</code></a></li><li><a href="#5-humanintheloopmiddleware" class="table-of-contents__link toc-highlight">5. <code>HumanInTheLoopMiddleware</code></a></li><li><a href="#6-todolistmiddleware" class="table-of-contents__link toc-highlight">6. <code>TodoListMiddleware</code></a></li><li><a href="#7-injectavailabletoolnamesmiddleware" class="table-of-contents__link toc-highlight">7. <code>InjectAvailableToolNamesMiddleware</code></a></li><li><a href="#8-injectavailablesubagentnamesmiddleware" class="table-of-contents__link toc-highlight">8. <code>InjectAvailableSubAgentNamesMiddleware</code></a></li><li><a href="#9-injectavailableskillnamesmiddleware" class="table-of-contents__link toc-highlight">9. <code>InjectAvailableSkillNamesMiddleware</code></a></li><li><a href="#10-toolretrymiddleware" class="table-of-contents__link toc-highlight">10. <code>ToolRetryMiddleware</code></a></li><li><a href="#11-patchtoolcallsmiddleware" class="table-of-contents__link toc-highlight">11. <code>PatchToolCallsMiddleware</code></a></li><li><a href="#12-filesystemmiddleware" class="table-of-contents__link toc-highlight">12. <code>FilesystemMiddleware</code></a></li><li><a href="#13-summarizationmiddleware" class="table-of-contents__link toc-highlight">13. <code>SummarizationMiddleware</code></a></li><li><a href="#14-anthropicpromptcachingmiddleware" class="table-of-contents__link toc-highlight">14. <code>AnthropicPromptCachingMiddleware</code></a></li></ul></li><li><a href="#adding-custom-middleware" class="table-of-contents__link toc-highlight">Adding Custom Middleware</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Get Started</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/">Introduction</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started">Installation</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/cli-reference">CLI Reference</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/examples">Examples</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Features</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/features/memory">Workspace Memory</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/features/hitl">Human-in-the-Loop</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/features/web-research">Web Research</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/features/script-executor">Script Executor</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Extend Ciri</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/built-in-skills">Built-in Skills</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/skills-guide">Skills Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/toolkits-guide">Toolkits Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/subagents-guide">Subagents Guide</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Project</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/roadmap">Roadmap</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/contributing">Contributing</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/security">Security</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/faq">FAQ</a></li><li class="footer__item"><a href="https://github.com/adimis-ai/ciri" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Adimis. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>